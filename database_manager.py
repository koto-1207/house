# database_manager.py

import sqlite3

DATABASE_FILE = "manuals.db"


def init_db():
    """
    データベースファイルを初期化し、マニュアルテーブルを作成します。
    """
    conn = None
    try:
        conn = sqlite3.connect(DATABASE_FILE)
        c = conn.cursor()
        c.execute(
            """
            CREATE TABLE IF NOT EXISTS manuals (
                id INTEGER PRIMARY KEY,
                title TEXT NOT NULL,
                body TEXT NOT NULL,
                keywords TEXT
            )
        """
        )
        conn.commit()
    except sqlite3.Error as e:
        print(f"データベース初期化エラー: {e}")
    finally:
        if conn:
            conn.close()


def insert_initial_data():
    """
    初期マニュアルデータをデータベースに挿入します。
    重複を防ぐため、存在しない場合のみ挿入します。
    """
    manuals_data = [
        {
            "title": "使用料",
            "body": "志業シェアハウスの使用料は、月額9,000円です。"
            "ただし、使用開始日や退去日の属する月については「月額×使用日数/その月の日数」で算出します。",
            "keywords": "使用料,月額,,部屋,退去日,",
        },
        {
            "title": "宿泊",
            "body": "スパルタキャンプ前日から終了日の翌日の宿泊まで、町への申請により「平泉町志業シェアハウス使用許可決定通知書の交付を受けた方のみ、宿泊可能です。"
            "使用開始時にシェアハウス玄関と個室の鍵をお渡ししますので、退去まで紛失することのないよう各自で責任をもって管理してください。"
            "使用許可者以外の方で無断で施設内に入れることは固く禁止します。スパルタキャンプ受講生で、宿泊以外で学習のため使用したいという方も町への申請が必要となります。(※講座開催期間中に開催される対面サポートは除く)"
            "各部屋の使用後は、戸締まりやエアコン・電灯等を十分に確認し、防犯・節電・節水に努めてください。",
            "keywords": "宿泊,使用許可,宿泊可,",
        },
        {
            "title": "施錠について",
            "body": "貴重品を管理する金庫等はありませんので、個室を離れる際は必ず施錠するなど防犯に努めて下さい。また、外出の際には必ず玄関を施錠するように心がけて下さい。"
            "帰舎時も同様です。",
            "keywords": "施錠,防犯,外出,帰舎,玄関",
        },
        {
            "title": "アメニティ",
            "body": "必要最低限の生活用品は準備しておりますが、アメニティ類はありませんので、必要なものは各自で用意してください。",
            "keywords": "アメニティ,生活用品,用意,必要,最低限",
        },
        {
            "title": "シェアハウスで準備していない主な物品",
            "body": "歯磨き用品、入浴用品(洗面器、浴室イス以外)、タオル(バスタオル含む)、ドライヤー、屋内用スリッパ(旅館時代のものがありますが数にかぎりがありますので常時使用不可とします)、ティッシュペーパー、座布団等",
            "keywords": "生活用品,歯磨き,入浴,タオル,ドライヤー,屋内用スリッパ,ティッシュペーパー,座布団",
        },
        {
            "title": "お金に関すること",
            "body": "シェアハウスでは「自分のことは自分で」が基本ルールとなりますが、食費をはじめ、費用を出し合って負担する場合は、例外なく必ず均等に負担してください。"
            "年齢や職業などそれぞれ違いはありますが、受講生として立場は同じであることをしっかりと認識し、十分な生活費の準備をお願いします",
            "keywords": "生活費,均等,負担,お金",
        },
        {
            "title": "その他の使用者について",
            "body": "シェアハウスには、平泉町と連携協定を締結し事業を実施する「世界と平泉株式会社」が入居しています。",
            "keywords": "世界と平泉,オフィス,事務室,立ち入り",
        },
        {
            "title": "来客について",
            "body": "インターホンが鳴り、来訪者が訪れた場合は協力して応対してください。「世界と平泉株式会社」への来訪者以外には、平泉町まちづくり推進課に連絡するように伝えてください。",
            "keywords": "来訪者,インターホン",
        },
        {
            "title": "過ごし方について",
            "body": "施設周辺が住宅街であることを十分に留意し、ルールと節度を守って生活してください。"
            "敷地内でのバーベキューや花火は厳禁です。また地域の人を見かけたときは、挨拶をするなどして、交流のきっかけにしましょう",
            "keywords": "交流,きっかけ,節度,生活,バーベキュー,花火",
        },
        {
            "title": "駐車場について",
            "body": "シェアハウス敷地内の駐車スペースには限り(6~7台程度)があり、白線もありません。"
            "車の所有者どうしで調整して駐車してください。路上駐車は絶対しないでください。"
            "シェアハウスの南側は「世界と平泉株式会社」の車両駐車スペースとなっておりますので、平日の駐車はできません。(金曜の夜から日曜日までは駐車可)",
            "keywords": "駐車場,路上駐車,車両,駐車",
        },
        {
            "title": "移動手段・車の乗り合い",
            "body": "講座会場(株式会社長島製作所平泉工場)までの移動手段は各自で確保してください。"
            "バス路線はありますが、始発に乗車しても講座の開始時間(午前8時30分)には間に合いませんので注意そてください。"
            "講座会場への移動や買い出しなど、乗り合いで車を使用する場合は、車の所有者とトラブルのないよう、使用者どうしでしっかりとルールを決めて下さい。",
            "keywords": "移動手段,バス路線,開始時間,車の乗り合い,トラブル防止",
        },
        {
            "title": "食堂",
            "body": "厨房に隣接する共有スペースの大広間です。"
            "食事だけではなく、使用者どうしの交流や学習に積極的に活用してください。テレビは食堂にのみ設置しております"
            "備え付けの座卓、折りたたみテーブルとイスは自由な配置で使用してください。"
            "折りたたみテーブルとイスについて、個室で使用することも可能です。",
            "keywords": "食堂,共有スペース,交流,学習,テレビ,座卓,折りたたみテーブル,イス,個室利用",
        },
        {
            "title": "個室",
            "body": "2階の個室は1人部屋または2人部屋での使用となり、「シェアハウス玄関」と「2階個室」の鍵を個人ごとにお渡しします。"
            "また、2階部屋にはパーティションを用意していますので、ルームメイトと相談しながら使用して下さい。"
            "いびきをかく方や気になる方は事前にルームメイトに伝えておくこと。"
            "また、お互いにいびき対策グッズを使用してください。"
            "個室でも食事は可能ですが、室内や備品を汚損することのないようにしてください。",
            "keywords": "個室,1人部屋,2人部屋,,パーティション,ルームメイト,いびき,対策グッズ,食事,汚損防止",
        },
        {
            "title": "寝具",
            "body": "敷布団、掛布団、枕、それぞれのカバーの計8点の寝具類を1人1セット準備していますので、不足の場合は各自で必要に応じて準備してください。"
            "また、定期的にカバーの洗濯(洗濯機で可)や布団干しをしてください。",
            "keywords": "寝具,敷布団,掛布団,枕,カバー,1人1セット,不足,洗濯,布団干し",
        },
        {
            "title": "個室の鍵の閉じこみについて",
            "body": "室内に鍵を置いたまま、室外からドアをロックしてしまった時は、平泉町役場に合鍵を用意していますので、身分証明書(運転免許証)を持って必ず本人が取りに来て下さい。"
            "曜日及び時間帯によって対応窓口が変わりますので注意して下さい。"
            "平日(8:30~17:15)の場合 → 平泉町役場2階のまちづくり推進課窓口へ"
            "土日祝(8:30~17:15)の場合 → 平泉町役場1階の町民福祉課窓口(日直)へ"
            "上記以の場合 → 平泉町役場裏口の警備員室へ"

            "窓口で身分証明書を提示し本人確認を受け、鍵持出簿に氏名・部屋名・鍵の持出時間を記載した後に合鍵が渡されます。なお、開場後はすぐに合鍵を返却するようにください。"
            "対応窓口に鍵を返却し、鍵持出簿に返却時間を記載します。"
            "警備員が就寝中又は見回り中の場合は、入口右側のインターホンを押して下さい",
            "keywords": "",
        },
        {
            "title": "炊事施設",
            "body": "共用の厨房が使用可能です。"
            "冷蔵庫、電子レンジ、炊飯器、電気ポット、ガステーブルのほか、包丁、まな板、フライパン、鍋、ボウル、ざる、菜箸、ピーラー、栓抜き(缶切り)など"
            "必要最低限な調理器具や食器、食器用洗剤やスポンジ、ふきんを準備しています。その他必要な物品は各自で用意してください。"
            "冷蔵庫内等の食材の管理はマジックペンで名前を書いておくなど、使用者どうしで話し合って予めルールを決めて下さい。",
            "keywords": "",
        },
        {
            "title": "リネン室",
            "body": "洗濯機を備え付けており、無料で使用できます。ただし、乾燥機能はありませんので必要に応じて近隣のコインランドリーを利用してください。"
            "洗剤や物干し用のハンガーは共用として準備しており、数に限りがありますので各自で用意するか、使用者どうしで話し合って使用して下さい。"
            "なお、外に洗濯物を干す敷地外(道路等)にはみ出すことのないようにしてください。",
            "keywords": "",
        },
        {
            "title": "浴室",
            "body": "浴室(男女各浴室にシャワー2口)はシャワー浴のみとなります。お湯になるまでに時間がかかる場合があります。"
            "シャンプーやボディソープ、洗身用タオルやバスタオル、ドライヤーは各自準備してください。"
            "また近隣に町民温泉がありますのでご利用ください。",
            "keywords": "",
        },
            {
            "title": "冷暖房設備",
            "body": "食堂及び各個室には冷房用にエアコン(※冷房専用)、暖房用に灯油式ファンヒーターを設置しております。"
            "全館空調設備がありますが、故障により使用不可となっておりますので、ご注意ください。",
            "keywords": "",
        },
        {
            "title": "エアコン",
            "body": "講座参加やその他外出など、部屋に長時間不在となる場合は必ず電源を切って下さい。",
            "keywords": "",
        },
        {
            "title": "灯油の補給",
            "body": "リネン室奥の土間に灯油のポリタンクを準備しておりますので、ファンヒーターへの補給はポリタンクから行って下さい。"
            "また、ポリタンクが空になった場合は、外のタンクからポリタンクに灯油を入れておいて下さい。",
            "keywords": "",
        },
        {
            "title": "Wi-Fi",
            "body": "課題学習用にWi-Fiを整備しておりますので、活用して下さい"
            "【SSID】share-house_Wi-Fi"
            "【Password】I11264@1",
            "keywords": "",
        },
        {
            "title": "喫煙",
            "body": "施設は完全喫煙です。"
            "喫煙される方は屋外の指定スペースでお願いします。なお、火の始末には十分留意するとともに、吸い殻は携帯用灰皿で管理し、各自で責任をもって処分してください。",
            "keywords": "",
        },
        {
            "title": "清掃、ごみ出し",
            "body": "個室はその使用者が、共用部分は全員で、定期的(3日に1回以上)に清掃を行い、施設の清潔を保持してください。清掃用事はリネン室にまとめて置いています。"
            "各部屋から出たごみは厨房にあるごみ箱(大)に分別してまとめ、いっぱいになったごみ袋は絡んでリネン室の奥にある土間に置いて持込日を厳守を厳守してください。"
            "ごみ分別のルールブックは厨房のごみ袋付近に設置しています。シェアハウスのごみは事業者系ごみとして回収しますので、持込日を厳守してください。"
            "代えのごみ袋はリネン室へ置いておきますので、必ず指定のごみ袋を使用してください。"
            "まとめたゴミは指定する持込日に平泉役場の集積所に搬入してください。"
            "ごみ出しの当番等は使用者どうしで相談して決めて、責任をもって行ってください。",
            "keywords": "",
        },
        {
            "title": "ごみの持込日",
            "body": "平泉町役場の集積場への持込日(時間)" 
            "燃やすごみ → 毎週月曜日または木曜日(午後5時までに)"
            "燃やせないごみ → 毎週月曜日(午後5時までに)"
            "プラスチックごみ(発泡スチロール含む) → 毎週月曜日(午後5時までに)"
            "かん → 毎月第2・第4週の水曜日(午後5時までに)"
            "びん → 毎月第2・第4週の水曜日(午後5時までに)"
            "ペットボトル → 毎月第2・第4週の水曜日(午後5時までに)"
            "紙、段ボール →毎月第2・第4週の水曜日(午後5時までに)"
            "ごみの持込日が祝日の場合は、次回の持込日に搬入するようにしてください。",
            "keywords": "",
        },
        {
            "title": "ごみの搬入の流れ",
            "body": "平泉町役場裏手の集積所の前にごみを置く。"
            "※車で持参した場合は、役場裏のスペースに一時的に駐車して構いませんが、公用車が車庫に出入りしますので、注意して駐車してください"
            "集積所は施錠されていますので、必ず平泉町役場2階のまちづくり推進課に「シェアハウスのごみ出しに来た」ことを伝えてください。"
            "職員が立ち会って集積所を開錠し、分別チェック後にごみを格納します。",
            "keywords": "",
        },
        {
            "title": "雪かき",
            "body": "雪かきを行った際は、雪を必ず敷地内にまとめておくようにしてください。道路に出したり、隣接する他の所有者の敷地に落とすことのないよう注意してください。",
            "keywords": "",
        },
        {
            "title": "荷物の送付",
            "body": "荷物等の事前送付は説明会開催日時以降での受け取りで発送可能ですが、必要なものはできるだけ持参していただくか、自分が施設に到着した段階で配送の手配をしてください。"
            "宛先については、「平泉町志業シェアハウス スパルタキャンプ参加者◯◯◯◯」と明示してください。なお、講座を実施する土日に到着することのないようにしてください。",
            "keywords": "",
        },
        {
            "title": "感染症対策、体調管理",
            "body": "シェアハウスは集団生活のため、感染症のリスクが高くなりますので、基本的な感染症対策にご協力をお願いします。"
            "講座の実施にも直接影響が出ますので、健康状態には十分留意し、自分でしっかりと体調管理を行ってください。"
            "なお、非接触型体温計を玄関ホールのカウンターに備え付けておりますので、必要に応じて使用してください。",
            "keywords": "",
        },
        {
            "title": "手洗いや消毒による手指衛生の保持",
            "body": "施設内各所にハンドソープと手指消毒液を設置していますので、外出先から帰舎した時やトイレ後、食事前など、手指衛生の保持に努めてください。",
            "keywords": "",
        },
        {
            "title": "場面に応じた適切なマスクの着用",
            "body": "自身を感染から守るために、また、周囲に感染を広げないためにも体調不良時にはマスクを活用してください。",
            "keywords": "",
        },
        {
            "title": "施設の換気",
            "body": "共用部分、個室を問わず、できるだけ定期的な換気(1時間に1回、2方向の窓を開けて 5~10分程度)をお願いします。",
            "keywords": "",
        },
        {
            "title": "体調が悪くなった場合",
            "body": "軽度の発熱や倦怠感などの場合には、まず市販薬等を服用する、検査キットを使用するなどしてください。"
            "重症化リスクの高い場合や高熱などの重い症状が続く場合は、早急に医療機関に受信するとともに、まちづくり推進課(※担当者へ)への連絡をお願いします。"
            "感染症(新型コロナウイルス、インフルエンザ)に罹患した場合"
            "講座への出席は控えていただきます。(オンラインによる受講に切り替え)"
            "出席を控えていただく期間は医師の指示に基づきますが、外出を控える一般的な目安の期間は"
            "新型コロナウイルス感染症の場合: 発症日を0日目として5日間"
            "インフルエンザの場合: 発熱がなくなってから2日目まで",
            "keywords": "",
        },
        {
            "title": "公共入浴施設",
            "body": "平泉町健康福祉交流館「悠久の湯平泉温泉」"
            "所在地: 岩手県西磐井郡平泉町平泉字大沢1-1"
            "営業時間: 午前10時~午後9時"
            "定休日: 毎週火曜日(祝日等の場合は除きます。)",
            "keywords": "",
        },
        {
            "title": "退去時の確認",
            "body": "シェアハウスの退去をする時は、必ず退去日にまちづくり推進課職員の検査を受けてから退去してください。"
            "汚損等により修繕の必要がある場合、その内容と方法については職員の指示に従ってください。経費が発生する場合は、全額使用者の負担となります。",
            "keywords": "",
        },
        {
            "title": "その他",
            "body": "施設や設備に不具合や故障があった場合はまちづくり推進課に連絡してください。"
            "また、故意、過失によって施設や設備を汚損した場合や物品を紛失した場合には、放置せず早急に申し出てください。",
            "keywords": "",
        },
        {
            "title": "連絡・相談先",
            "body": "シェアハウス、講座、体調のことをはじめ、その他諸々について相談したい場合は、下記担当まで気軽に連絡してください。"
            "平日の午前8時30分~午後5時15分 → まちづくり推進課: 0191-46-5578(直通)"
            "それ以外 → 平泉町役場 宿直: 0191-46-2111(代表)",
            "keywords": "",
        },
        {
            "title": "施設概要",
            "body": "平泉町志業シェアハウスは岩手県西磐井郡平泉町にあります。個室5室と共用部（キッチン、リビングなど）が利用可能です。",
            "keywords": "概要,場所,アクセス,部屋,設備,平泉町",
        },
        {
            "title": "アクセス",
            "body": "自動車は平泉前沢ICまたは平泉スマートICから5分、電車はJR平泉駅から徒歩10分です。",
            "keywords": "アクセス,交通,自動車,電車,平泉駅",
        },
    ]

    conn = None
    try:
        conn = sqlite3.connect(DATABASE_FILE)
        c = conn.cursor()
        for manual in manuals_data:
            c.execute(
                "INSERT OR IGNORE INTO manuals (title, body, keywords) VALUES (?, ?, ?)",
                (manual["title"], manual["body"], manual["keywords"]),
            )
        conn.commit()
    except sqlite3.Error as e:
        print(f"データ挿入エラー: {e}")
    finally:
        if conn:
            conn.close()


def search_manuals_by_keyword(keyword: str):
    """
    キーワードに基づいてマニュアルを検索します。
    """
    conn = None
    try:
        conn = sqlite3.connect(DATABASE_FILE)
        c = conn.cursor()
        c.execute(
            "SELECT title, body FROM manuals WHERE keywords LIKE ?",
            (f"%{keyword}%",),
        )
        return c.fetchall()
    except sqlite3.Error as e:
        print(f"検索エラー: {e}")
        return []
    finally:
        if conn:
            conn.close()


def get_all_manuals():
    """
    すべてのマニュアルをデータベースから取得します。
    """
    conn = None
    try:
        conn = sqlite3.connect(DATABASE_FILE)
        c = conn.cursor()
        c.execute("SELECT title, body FROM manuals")
        return c.fetchall()
    except sqlite3.Error as e:
        print(f"データ取得エラー: {e}")
        return []
    finally:
        if conn:
            conn.close()
